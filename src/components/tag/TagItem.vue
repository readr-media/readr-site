<template>
  <li class="tag-item">
    <div class="tag-item__tag tag">
      <router-link
        :to="`/tag/${tagContent.id}`" 
        :class="[
          'tag__header',
          { 'tag__header--has-list': showRelatedsList && isRelatedListExist },
          { 'tag__header--highlight': isMouseover}
        ]"
        @mouseover.native="handleMouseEvent"
        @mouseout.native="handleMouseEvent"
      >
        <span class="tag__text" v-text="tagContent.text"></span>
        <Tooltip
          class="tag__action"
          :tooltipTexts="{ active: $t('FOLLOWING.FOLLOW_TAG'), deactive: $t('FOLLOWING.UNFOLLOW_TAG') }"
          :isActive="isFollowed"
          @toggle="clickFollow"
        >
          <img :src="isFollowed ? starUrlFollowed : starUrlUnFollowed">
        </Tooltip>
      </router-link>
      <ul
        v-if="showRelatedsList && isRelatedListExist"
        :class="[ 'tag__relateds-list', { 'tag__relateds-list--colorize-triangle': isMouseover } ]"
      >
        <div class="tag__category" v-text="$t('TAG_NAV_ASIDE.CATEGORY.PROJECT')"></div>
        <TagItemRelatedsListItem
          v-for="(item, i) in relatedListItems"
          :data="item"
          :key="i"
          class="tag__relateds-list-item"
        />
      </ul>
    </div>
    <!-- TODO: add trending-rank -->
    <!-- <p v-if="showTrendingRank" class="tag-item__trending-rank"></p> -->
  </li>
</template>

<script>
import TagItemRelatedsListItem from './TagItemRelatedsListItem.vue'
import Tooltip from 'src/components/Tooltip.vue'
import { get, take, } from 'lodash'
import { mapState, } from 'vuex'

const publishAction = (store, data) => store.dispatch('FOLLOW', { params: data, })
const switchOn = (store, message) => store.dispatch('LOGIN_ASK_TOGGLE', { active: true, message, type: 'GO_LOGIN', })
const toogleFollowingByUserStat = (store, { resource, resourceType = '', targetId, }) => {
  return store.commit('TOOGLE_FOLLOWING_BY_USER_STAT', {
    params: {
      resource,
      resourceType,
      targetId,
    },
  })
}

export default {
  name: 'TagItem',
  props: {
    tag: {
      type: Object,
      required: true,
    },
    showTrendingRank: {
      type: Boolean,
      default: false,
    },
    showRelatedsList: {
      type: Boolean,
      default: false,
    },
  },
  components: {
    TagItemRelatedsListItem,
    Tooltip,
  },
  data () {
    return {
      isMouseoverLocal: false, // For preserving mouseover effect when tag's isMouseover status is not exist
      relatedListName: 'taggedReports',
      relatedListItemLimit: 3,
    }
  },
  computed: {
    ...mapState({
      userId: state => state.profile.id,
      tagsFollowingByUser: state => get(state.followingByUserStats, 'tag', {}),
    }),
    isFollowed () {
      return get(this.tagsFollowingByUser, this.tagContent.id, false)
    },
    isLoggedIn () {
      return this.$store.state.isLoggedIn
    },
    isRelatedListExist () {
      return this.relatedListName in this.tagContent && this.tagContent[this.relatedListName] !== null
    },
    relatedListItems () {
      return take(get(this.tagContent, this.relatedListName, []), this.relatedListItemLimit)
    },
    isMouseover () {
      return get(this.$store.state, [ 'tagsIsMouseover', this.tagContent.id, ], this.isMouseoverLocal)
    },
    starUrlFollowed () {
      return this.isMouseover ? '/public/icons/star-white.png' : '/public/icons/star-blue.png'
    },
    starUrlUnFollowed () {
      return this.isMouseover ? '/public/icons/star-whiteline.png' : '/public/icons/star-line-blue.png'
    },
    tagContent () {
      return this.tag.resource === 'tag' ? get(this.tag, 'item') || {} : this.tag
    },
  },
  methods: {
    // TODO: Refactor following to a component like ButtonFollow.vue
    clickFollow (e) {
      e.preventDefault()

      if (this.isLoggedIn) {
        this.toogleFollow()
      } else {
        switchOn(this.$store)
      }
    },
    toogleFollow () {
      if (this.isFollowed) {
        publishAction(this.$store, {
          action: 'unfollow',
          resource: 'tag',
          subject: this.$store.state.profile.id,
          object: this.tagContent.id,
        })
      } else {
        publishAction(this.$store, {
          action: 'follow',
          resource: 'tag',
          subject: this.$store.state.profile.id,
          object: this.tagContent.id,
        })
      }
      toogleFollowingByUserStat(this.$store, { resource: 'tag', targetId: this.tagContent.id, })
    },
    handleMouseEvent (e) {
      this.isMouseoverLocal = e.type === 'mouseover'
      this.$store.commit('SET_TAGS_MOUSEEVENT', { id: this.tagContent.id, value: e.type === 'mouseover', })
    },
  },
}
</script>

<style lang="stylus" scoped>
.tag-item
  display inline-flex
  align-items flex-start
  &__tag
    // font-size .9375rem
    line-height 1.5rem
    // font-weight 700
    border 1px solid #11b8c9
    border-radius 12px
    user-select none
    background-color white
    flex 1 1 auto
  &__trending-rank
    width 22.5px
    min-width 22.5px
    height 24px
    line-height 24px
    font-size 9px
    text-align center
    margin 0 0 0 6px

.tag
  &__header
    padding 0 8px 0 13.5px
    display flex
    justify-content space-between
    align-items center
    border-radius 12px
    background-color white
    color black
    transition background-color .1s ease-out, color .1s ease-out
    &--has-list
      border-radius 0
      border-top-left-radius 12px
      border-top-right-radius 12px
    &--highlight
      background-color #11b8c9
      color white
  &__text
    font-size 12px
    font-weight 700
    white-space nowrap
    overflow hidden
    text-overflow ellipsis
  &__action
    margin-left 5px
    >>> img
      position relative
      top 2px
      width 20px
      height 15px
      padding-left 5px
      border-left 1px solid #d3d3d3
      cursor pointer
  &__relateds-list
    list-style none
    margin 0
    padding 9px 8px 9px 13.5px
    border-top 1px solid #11b8c9
    position relative
    &:before
      content ''
      position absolute
      top 0
      left 30px
      width 0
      height 0
      border-style solid
      border-width 10px 4px 0 4px
      border-color #11b8c9 transparent transparent transparent
    &:after
      content ''
      position absolute
      top -1px
      left 31px
      width 0
      height 0
      border-style solid
      border-width 9px 3px 0 3px
      border-color white transparent transparent transparent
      transition border-color .1s ease-out
    &--colorize-triangle
      &:after
        content ''
        position absolute
        top -1px
        left 31px
        width 0
        height 0
        border-style solid
        border-width 9px 3px 0 3px
        border-color #11b8c9 transparent transparent transparent
  &__relateds-list-item
    & + &
      border-top 1px solid #d3d3d3
  &__category
    position absolute
    top 0
    left -21px
    width 20px
    padding .5em 0 .2em
    color #000
    font-size .5625rem
    line-height 20px
    letter-spacing .3em
    writing-mode vertical-rl
    background-color #ddcf21
    user-select none
    cursor default
</style>


