<template>
  <div class="login" @keyup="keyupHandler" :class="{ 'dark': theme === 'dark' }">
    <TextItem class="login__input-email" type="text"
      :placeHolder="$t('login.WORDING_EMAIL_PLACEHOLDER')"
      :alert.sync="alert.mail"
      :backgroundColor="theme === 'dark' && '#444746'"
      :border="theme === 'dark' && 'solid 1px #ffffff'"
      :height="theme === 'dark' && '25px'"
      :color="theme === 'dark' && '#fff'"
      :fontSize="theme === 'dark' && '0.9375rem'"
      :value.sync="formData.mail"></TextItem>
    <TextItem class="login__input-pwd" type="password"
      :placeHolder="$t('login.WORDING_PASSWORD')"
      :alert.sync="alert.pwd"
      :backgroundColor="theme === 'dark' && '#444746'"
      :border="theme === 'dark' && 'solid 1px #ffffff'"
      :height="theme === 'dark' && '25px'"
      :color="theme === 'dark' && '#fff'"
      :fontSize="theme === 'dark' && '0.9375rem'"
      :value.sync="formData.pwd"></TextItem>
    <div class="login__wrapper">
      <div class="keep-login-alive">
        <input type="checkbox" id="keep-alive" ref="keep-alive">
        <label for="keep-alive" v-text="' ' + $t('login.WORDING_KEEP_ALIVE')"></label>
      </div>
      <div class="forget-pwd">
        <span v-text="$t('login.WORDING_FORGET_PASSWORD')" @click="goRecoverPwd"></span>
      </div>
    </div>
    <div class="login__msg">
      <div class='content' v-text="resMsg"></div>
    </div>
    <div class="login__btn" @click="login">
      <span v-text="$t('login.WORDING_LOGIN')"></span>
    </div>
  </div>
</template>
<script>
  import { ROLE_MAP, } from 'src/constants'
  import { filter, get, } from 'lodash'
  import TextItem from 'src/components/form/TextItem.vue'
  import validator from 'validator'

  const debug = require('debug')('CLIENT:Login')
  const login = (store, profile, token) => {
    return store.dispatch('LOGIN', {
      params: {
        email: profile.email,
        password: profile.password,
        keepAlive: profile.keepAlive,
      },
      token,
    })
  }

  export default {
    components: {
      TextItem,
    },
    data () {
      return {
        alert: {},
        formData: {},
        resMsg: null,
      }
    },
    name: 'Login',
    methods: {
      goRecoverPwd () {
        this.$emit('goRecoverPwd')
      },
      keyupHandler (e) {
        if (e.keyCode === 13) {
          this.login()
        }
      },
      login () {
        if (this.validatInput()) {
          login(this.$store, {
            email: this.formData.mail,
            password: this.formData.pwd,
            keepAlive: this.$refs[ 'keep-alive' ].checked,
          }, get(this.$store, [ 'state', 'register-token', ])).then((res) => {
            if (res.status === 200) {
              const memberCenter = get(filter(ROLE_MAP, { key: get(this.$store, [ 'state', 'profile', 'role', ]), }), [ 0, 'route', ], 'member')
              this.$route.path === '/comment' ? this.$router.push(this.$route.fullPath) : this.$router.push(`/${memberCenter}`)
              // location.replace(`/${memberCenter}`)
            } else {
              this.resMsg = this.$t('login.WORDING_LOGIN_INFAIL_VALIDATION_ISSUE')
            }
          }).catch((err) => {
            if (err.status === 401) {
              this.resMsg = this.$t('login.WORDING_LOGIN_UNAUTHORIZED')
            }
          })
        }
      },
      validatInput () {
        let pass = true
        if (!this.formData.mail || !validator.isEmail(this.formData.mail)) {
          pass = false
          this.alert.mail = {
            flag: true,
            msg: this.$t('login.WORDING_REGISTER_EMAIL_VALIDATE_IN_FAIL'),
          }
          debug('Mail wrong', this.formData.mail)
        }
        if (!this.formData.pwd || validator.isEmpty(this.formData.pwd)) {
          pass = false
          this.alert.pwd = {
            flag: true,
            msg: this.$t('login.WORDING_REGISTER_PWD_EMPTY'),
          }
          debug('Empty pwd', this.formData.pwd)
        }
        this.$forceUpdate()
        return pass
      },
    },
    props: {
      theme: {
        default: () => 'normal',
      },
    },
  }
</script>
<style lang="stylus" scoped>
  .login.dark
    .login__btn
      background-color #ddcf21
      color #000
      width 400px
      height 25px
      font-size 0.9375rem
      &:hover
        background-color #8c8c8c

    .login__wrapper
      font-family PingFangTC
      font-size 0.75rem
      font-weight normal
      font-style normal
      font-stretch normal
      line-height normal
      letter-spacing normal
      text-align right
      color #ffffff
      .keep-login-alive
        > input
          vertical-align middle
          width 13px
          height 13px
  .login
    width 100%
    height 100%
    position relative
    padding-bottom 2rem
    color #000
    &__input-email, &__input-pwd
      margin 15px 0
    &__wrapper
      display flex
      justify-content space-between
      font-size 0.875rem
      .keep-login-alive
        > input
          vertical-align top
          width 15px
          height 15px
    &__msg
      margin 15px 0
      width 100%
      text-align right
      color red
    &__btn
      position absolute
      bottom 0
      left 0
      width 100%
      height 35px
      background-color #444746
      color #ddcf21
      display flex
      justify-content center
      align-items center
      cursor pointer
      &:hover
        background-color #737373
  .forget-pwd
    cursor pointer
</style>
